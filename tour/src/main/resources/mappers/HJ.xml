<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oracle.tour.HJMapper">
	<select id="hjMemberDetail" parameterType="String" resultType="Member">
		select * from member where m_id=#{m_id}
	</select>
	
	<!-- 전체, 검색X -->
	<select id="hjBoardTotal_n" resultType="int">
		select count(*) from Board
	</select>
	<!-- 전체, 검색O -->
	<select id="hjBoardTotal_y" resultType="int" parameterType="Board">
		select count(*) from Board
        <choose>
		 	 <when test="searchType == 'b_title'">
		    		WHERE b_title like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="searchType == 'b_contents'">
		    		WHERE b_contents like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="searchType == 'm_nickname'">
		    		WHERE m_nickname like '%' || #{keyword} || '%'    
		   	 </when>
        </choose>
	</select>
	<!-- 유형별, 검색X -->
	<select id="hjBoardKindTotal_n" resultType="int" parameterType="Board">
		select count(*) from Board
		<choose>
		 	 <when test="b_kind == 1">
		    		WHERE b_kind in (1, 4)   
		   	 </when>
		 	 <when test="b_kind == 2">
		    		WHERE b_kind in (2, 4)   
		   	 </when>
		 	 <when test="b_kind == 3">
		    		WHERE b_kind in (3, 4)   
		   	 </when>
		</choose>
	</select>
	<!-- 유형별, 검색O -->
	<select id="hjBoardKindTotal_y" resultType="int" parameterType="Board">
		select count(*) from Board
		        <choose>
		 	 <when test="b_kind == 1 and searchType == 'b_title'">
		    		WHERE b_kind in (1, 4)
		    		AND b_title like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="b_kind == 1 and searchType == 'b_contents'">
		    		WHERE b_kind in (1, 4)
		    		AND b_contents like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="b_kind == 1 and searchType == 'm_nickname'">
		    		WHERE b_kind in (1, 4)
		    		AND m_nickname like '%' || #{keyword} || '%'    
		   	 </when>
		   	 
		 	 <when test="b_kind == 2 and searchType == 'b_title'">
		    		WHERE b_kind in (2, 4)
		    		AND b_title like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="b_kind == 2 and searchType == 'b_contents'">
		    		WHERE b_kind in (2, 4)
		    		AND b_contents like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="b_kind == 2 and searchType == 'm_nickname'">
		    		WHERE b_kind in (2, 4)
		    		AND m_nickname like '%' || #{keyword} || '%'    
		   	 </when>
		   	 
		 	 <when test="b_kind == 3 and searchType == 'b_title'">
		    		WHERE b_kind in (3, 4)
		    		AND b_title like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="b_kind == 3 and searchType == 'b_contents'">
		    		WHERE b_kind in (3, 4)
		    		AND b_contents like '%' || #{keyword} || '%'    
		   	 </when>
		 	 <when test="b_kind == 3 and searchType == 'm_nickname'">
		    		WHERE b_kind in (3, 4)
		    		AND m_nickname like '%' || #{keyword} || '%'    
		   	 </when>
        </choose>
	</select>
	
	<!-- 전체 검색 안 하는 경우 -->	
	<select id="hjBoardList1_old" parameterType="Board" resultType="Board">
	  select *
		from (
		   	  select rownum rn, a.*
		  	  from (select b.* , m.m_nickname, m.m_active_kind
                    from   board b, member m 
                    where b.m_id = m.m_id
                    order by b_notice desc, b_date desc, b_no) a
		     )
		where rn between #{start} and #{end}
	</select>
	<!-- 전체 검색하는 경우 -->
	<select id="hjBoardList1" parameterType="Board" resultType="Board">
		  select *
			from (
			   	  select rownum rn, a.*
			  	  from (select b.* , m.m_nickname, m.m_active_kind
	                    from   board b, member m 
	                    where b.m_id = m.m_id
	                    <choose>
						 	 <when test="searchType == 'b_title'">
						    		AND b_title like '%' || #{keyword} || '%'    
						   	 </when>
						 	 <when test="searchType == 'b_contents'">
						    		AND b_contents like '%' || #{keyword} || '%'    
						   	 </when>
						   	 <otherwise>
						   	  	    AND m_nickname like '%' || #{keyword} || '%'   
							 </otherwise>
					    </choose>
	                    order by b_notice desc, b_date desc, b_no) a
			     )
			where rn between #{start} and #{end}
	</select>
	
	<!-- 유형별 검색 안 하는 경우 -->	
	<select id="hjBoardList2_old" parameterType="Board" resultType="Board">
	    select *
		from (
		   	  select rownum rn, a.*
		  	  from (select b.* , m.m_nickname, m.m_active_kind
                    from   board b, member m 
                    where b.m_id = m.m_id
                    and b_kind in (#{b_kind}, 4)   
                    order by b_notice desc, b_date desc, b_no) a
		     )
		where rn between #{start} and #{end}
	</select>
	<!-- 유형별 검색하는 경우 -->
	<select id="hjBoardList2" parameterType="Board" resultType="Board">
	    select *
		from (
		   	  select rownum rn, a.*
		  	  from (select b.* , m.m_nickname, m.m_active_kind
                    from   board b, member m 
                    where b.m_id = m.m_id
                   	<choose>
					 	 <when test="b_kind == 1 and searchType == 'b_title'">
					    		AND b_kind in (1, 4)
					    		AND b_title like '%' || #{keyword} || '%'    
					   	 </when>
					 	 <when test="b_kind == 1 and searchType == 'b_contents'">
					    		AND b_kind in (1, 4)
					    		AND b_contents like '%' || #{keyword} || '%'    
					   	 </when>
					 	 <when test="b_kind == 1 and searchType == 'm_nickname'">
					    		AND b_kind in (1, 4)
					    		AND m_nickname like '%' || #{keyword} || '%'    
					   	 </when>
					   	 
					 	 <when test="b_kind == 2 and searchType == 'b_title'">
					    		AND b_kind in (2, 4)
					    		AND b_title like '%' || #{keyword} || '%'    
					   	 </when>
					 	 <when test="b_kind == 2 and searchType == 'b_contents'">
					    		AND b_kind in (2, 4)
					    		AND b_contents like '%' || #{keyword} || '%'    
					   	 </when>
					 	 <when test="b_kind == 2 and searchType == 'm_nickname'">
					    		AND b_kind in (2, 4)
					    		AND m_nickname like '%' || #{keyword} || '%'    
					   	 </when>
					   	 
					 	 <when test="b_kind == 3 and searchType == 'b_title'">
					    		AND b_kind in (3, 4)
					    		AND b_title like '%' || #{keyword} || '%'    
					   	 </when>
					 	 <when test="b_kind == 3 and searchType == 'b_contents'">
					    		AND b_kind in (3, 4)
					    		AND b_contents like '%' || #{keyword} || '%'    
					   	 </when>
					 	 <otherwise>
					    		AND b_kind in (3, 4)
					    		AND m_nickname like '%' || #{keyword} || '%'    
					   	 </otherwise>
					</choose>
                    order by b_notice desc, b_date desc, b_no) a
		     )
		where rn between #{start} and #{end}
	</select>

	<update id="hjGetHit" parameterType="Board">
		update board set b_hit = b_hit+1 where b_kind = #{b_kind} and b_no = #{b_no}
	</update>
	
	<select id="hjBoardDetail" parameterType="Board" resultType="Board">
		select b.*, m.m_nickname, m.m_active_kind, m_kind
		from board b, member m
		where b.m_id = m.m_id
		and b.b_kind = #{b_kind}
		and b.b_no = #{b_no}
	</select>
	
	<select id="hjNicknameSelect" parameterType="java.lang.String" resultType="java.lang.String">
		select m_nickname from member where m_id = #{m_id}
	</select>
	
	<insert id="hjBoardInsert" parameterType="Board">
<!-- 		<selectKey keyProperty="b_no_seq" resultType="int" order="BEFORE"> -->
<!-- 			select b_no_seq.nextval from dual -->
<!-- 		</selectKey> -->
<!-- 		<selectKey keyProperty="b_group_seq" resultType="int" order="BEFORE"> -->
<!-- 			select b_group_seq.nextval from dual -->
<!-- 		</selectKey> -->
		insert into board values(#{b_kind}, b_no_seq, #{m_id}, #{b_title}, #{b_contents}, sysdate, 0,
								 #{b_filename}, b_group_seq, 0, 0, #{b_notice}, #{b_lock}, null)
	</insert>
	
	<delete id="hjBoardDelete" parameterType="Board">
		delete from board where b_kind = #{b_kind} and b_no = #{b_no}
	</delete>
	
	<select id="hjBLikeChk" parameterType="Board_like" resultType="int">
		select count(*) 
		from board_like 
		where b_kind = #{b_kind}
		and b_no = #{b_no}
		and m_id = #{m_id}
		and b_like_check = 'y'
	</select>
	
	<!-- b_like_check 'y' -> 'n'으로 변경 -->
	<update id="hjDislike_bl" parameterType="Board_like">
		update board_like
		set b_like_check = 'n'
		where b_kind = #{b_kind}
		and b_no = #{b_no}
		and m_id = #{m_id}
	</update>
	<!-- b_like_cnt -1처리 -->
	<update id="hjDislike_b" parameterType="Board">
		update board
		set b_like_cnt = b_like_cnt -1
		where b_kind = #{b_kind}
		and b_no = #{b_no}
	</update>
	
	<select id="hjselectLikeCnt" parameterType="Board" resultType="int">
		select b_like_cnt
		from board
		where b_kind = #{b_kind}
		and b_no = #{b_no}
	</select>
	
</mapper>